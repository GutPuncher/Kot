#include "monitor.h"

#include <kot++/printf.h>

uint8_t MouseMask[] = {
    0b10000000, 0b00000000, 
    0b11000000, 0b00000000, 
    0b11100000, 0b00000000, 
    0b11110000, 0b00000000, 
    0b11111000, 0b00000000, 
    0b11111100, 0b00000000, 
    0b11111110, 0b00000000, 
    0b11111111, 0b00000000, 
    0b11111111, 0b10000000, 
    0b11111111, 0b11000000, 
    0b11111111, 0b11100000, 
    0b11111110, 0b00000000, 
    0b11101111, 0b00000000, 
    0b11001111, 0b00000000, 
    0b10000111, 0b10000000, 
    0b00000111, 0b10000000, 
    0b00000011, 0b11000000, 
    0b00000011, 0b11000000, 
    0b00000001, 0b10000000, 
};

uint32_t CursorColor[CursorHeight][CursorWidth] = 
{
    { 0xDDDDDD, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B },
    { 0xDDDDDD, 0xDDDDDD, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B },
    { 0xDDDDDD, 0x2B2B2B, 0xDDDDDD, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B },
    { 0xDDDDDD, 0x2B2B2B, 0x2B2B2B, 0xDDDDDD, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B },
    { 0xDDDDDD, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0xDDDDDD, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B },
    { 0xDDDDDD, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0xDDDDDD, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B },
    { 0xDDDDDD, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0xDDDDDD, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B },
    { 0xDDDDDD, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0xDDDDDD, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B },
    { 0xDDDDDD, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0xDDDDDD, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B },
    { 0xDDDDDD, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0xDDDDDD, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B },
    { 0xDDDDDD, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0xDDDDDD, 0xDDDDDD, 0xDDDDDD, 0xDDDDDD, 0xDDDDDD, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B },
    { 0xDDDDDD, 0x2B2B2B, 0x2B2B2B, 0xDDDDDD, 0xDDDDDD, 0x2B2B2B, 0xDDDDDD, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B },
    { 0xDDDDDD, 0x2B2B2B, 0xDDDDDD, 0x2B2B2B, 0xDDDDDD, 0x2B2B2B, 0x2B2B2B, 0xDDDDDD, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B },
    { 0xDDDDDD, 0xDDDDDD, 0x2B2B2B, 0x2B2B2B, 0xDDDDDD, 0x2B2B2B, 0x2B2B2B, 0xDDDDDD, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B },
    { 0xDDDDDD, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0xDDDDDD, 0x2B2B2B, 0x2B2B2B, 0xDDDDDD, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B },
    { 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0xDDDDDD, 0x2B2B2B, 0x2B2B2B, 0xDDDDDD, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B },
    { 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0xDDDDDD, 0x2B2B2B, 0x2B2B2B, 0xDDDDDD, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B },
    { 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0xDDDDDD, 0x2B2B2B, 0x2B2B2B, 0xDDDDDD, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B },
    { 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0xDDDDDD, 0xDDDDDD, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B, 0x2B2B2B },
};

Monitor::Monitor(process_t orb, uintptr_t fb_addr, uint64_t width, uint64_t height, uint64_t pitch, uint64_t bpp, uint32_t xPos, uint32_t yPos) {
    
    this->xPos = xPos;
    this->yPos = yPos;

    main = (framebuffer_t*) calloc(sizeof(framebuffer_t));
    back = (framebuffer_t*) calloc(sizeof(framebuffer_t));

    main->addr = fb_addr;
    main->width = width;
    main->height = height;
    main->pitch = pitch;
    main->bpp = bpp;
    main->btpp = bpp / 8;
    main->size = main->pitch * height;

    back->addr = calloc(main->pitch * height);
    back->width = width;
    back->height = height;
    back->pitch = main->pitch;
    back->bpp = main->bpp;
    back->btpp = main->btpp;
    back->size = main->size;

    this->background = new Window(orb, width, height, bpp, this->xPos, this->yPos);
}

uint32_t Monitor::getWidth() {
    return this->main->width;
}

uint32_t Monitor::getHeight() {
    return this->main->height;
}

Window* Monitor::getBackground() {
    return this->background;
}

void Monitor::setBackground(Window* w) {
    this->background->destroy();
    free(this->background);
    this->background = w;
}

void Monitor::move(uint32_t xPos, uint32_t yPos) {
    this->xPos = xPos;
    this->yPos = yPos;
    this->background->move(xPos, yPos);
}

void dynamicBlit(framebuffer_t* to, framebuffer_t* from, uint32_t x, uint32_t y, uint32_t monitorXoffset, uint32_t monitorYoffset) {
    blitFramebuffer(to, from, x, y);
}

void Monitor::update(vector_t* windows) {

    if (this->background == NULL) {
        memset(this->back->addr, 0x00, this->main->size);
    } else {
        memcpy(this->back->addr, this->background->getFramebuffer()->addr, this->main->size);
    }

    for (uint32_t i = 0; i < windows->length; i++) {
        Window* window = (Window*) vector_get(windows, i);
        if (window != NULL) if (window->isVisible()) {
            dynamicBlit(this->back, window->getFramebuffer(), window->getX(), window->getY(), this->xPos, this->yPos);
        }
    }

    DrawCursor(this->back, MouseMask, CursorColor);

    memcpy(this->main->addr, this->back->addr, this->main->size);

}